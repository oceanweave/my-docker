## 1 | IPAM 模块（用于ip地址管理）

### 1.1 实现过程

1. 采用 bitmap 实现 ip 的管理
2. 创建子网管理 map（也就是 bitmap），key 为 subnet（子网网段，如 192.168.0.0/24），value 为【该子网网段可分配 ip 数量 - 1】的字符（ -1 表示网段初始 ip 为网关 ip 不分配，字符有两种形式，0 表示该 ip 已分配，1表示该ip 未分配）
3. load 函数，从宿主机指定 json 文件加载已有的 ipnet bitmap； dump 函数，将 ipnet bitmap 写入到宿主机指定 接送文件中
4. Allocate 函数，分配 ip
   - 首先采用 load 加载已有的 json 文件记录的 ipnet bitmap 信息
   - 若 json 文件不存在，也无所谓，表示可能第一次创建，因此将此 subnet 添加到 bitmap 中，再写入到宿主机对应 json 文件中（通过 dump 函数）
   - （不过此处有个待优化的点，避免该 json 文件被恶意删除，负责会丢失原有 ip 分配信息，导致后续分配 ip 会有重复，从而导致不同容器有相同 ip，造成通信冲突）
   - 寻找bitmap中空的位置（就是字符为0的位置），遇到第一个0字符即为待分配ip，根据 subnet 的首 ip，计算期与首ip的差值，根据该差值，将 bitmap 对应的 index 设置为 1，表示该 ip 已分配（该信息会通过 dump 函数更新到宿主机对应 json 文件中）
5. Release 函数，释放ip
   - load 加载 ip bitmap 信息，从 json 文件中读取
   - 根据 ip 反查其在 bitmap 中的位置，就是用 ip - 网段首 ip = 差值，差值就是下标，将其对应的字符改为0 （表示释放此 ip）
   - dump 持久化 ip bitmap 信息，存到 json 文件中

### 1.2 测试

``` sh
# 测试分配 ip
root@ubuntu20:/go-code/my-docker/pkg/network# go test -v -run TestAllocate
=== RUN   TestAllocate
INFO[0000] Try load Network-IPAM-ConfigFile: /var/lib/mydocker/network/ipam/subnet.json
    ipam_test.go:16: alloc ip: 192.168.0.1
--- PASS: TestAllocate (0.00s)
PASS
ok  	github.com/oceanweave/my-docker/pkg/network	0.001s
root@ubuntu20:/go-code/my-docker/pkg/network#
# ip分配图，已分配的 ip 位置置为 1
root@ubuntu20:/go-code/my-docker/pkg/network# cat /var/lib/mydocker/network/ipam/subnet.json
{"192.168.0.0/24":"100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"}
# 测试回收 ip
root@ubuntu20:/go-code/my-docker/pkg/network# go test -v -run TestRelease
=== RUN   TestRelease
--- PASS: TestRelease (0.00s)
PASS
ok  	github.com/oceanweave/my-docker/pkg/network	0.001s
root@ubuntu20:/go-code/my-docker/pkg/network#
# ip 回收，已回收的 ip 位置置为 0
root@ubuntu20:/go-code/my-docker/pkg/network# cat /var/lib/mydocker/network/ipam/subnet.json
{"192.168.0.0/24":"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"}
```

