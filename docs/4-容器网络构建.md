## 1 | IPAM æ¨¡å—ï¼ˆç”¨äºipåœ°å€ç®¡ç†ï¼‰

### 1.1 å®ç°è¿‡ç¨‹

1. é‡‡ç”¨ bitmap å®ç° ip çš„ç®¡ç†
2. åˆ›å»ºå­ç½‘ç®¡ç† mapï¼ˆä¹Ÿå°±æ˜¯ bitmapï¼‰ï¼Œkey ä¸º subnetï¼ˆå­ç½‘ç½‘æ®µï¼Œå¦‚ 192.168.0.0/24ï¼‰ï¼Œvalue ä¸ºã€è¯¥å­ç½‘ç½‘æ®µå¯åˆ†é… ip æ•°é‡ - 1ã€‘çš„å­—ç¬¦ï¼ˆ -1 è¡¨ç¤ºç½‘æ®µåˆå§‹ ip ä¸ºç½‘å…³ ip ä¸åˆ†é…ï¼Œå­—ç¬¦æœ‰ä¸¤ç§å½¢å¼ï¼Œ0 è¡¨ç¤ºè¯¥ ip å·²åˆ†é…ï¼Œ1è¡¨ç¤ºè¯¥ip æœªåˆ†é…ï¼‰
3. load å‡½æ•°ï¼Œä»å®¿ä¸»æœºæŒ‡å®š json æ–‡ä»¶åŠ è½½å·²æœ‰çš„ ipnet bitmapï¼› dump å‡½æ•°ï¼Œå°† ipnet bitmap å†™å…¥åˆ°å®¿ä¸»æœºæŒ‡å®š æ¥é€æ–‡ä»¶ä¸­
4. Allocate å‡½æ•°ï¼Œåˆ†é… ip
   - é¦–å…ˆé‡‡ç”¨ load åŠ è½½å·²æœ‰çš„ json æ–‡ä»¶è®°å½•çš„ ipnet bitmap ä¿¡æ¯
   - è‹¥ json æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¹Ÿæ— æ‰€è°“ï¼Œè¡¨ç¤ºå¯èƒ½ç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œå› æ­¤å°†æ­¤ subnet æ·»åŠ åˆ° bitmap ä¸­ï¼Œå†å†™å…¥åˆ°å®¿ä¸»æœºå¯¹åº” json æ–‡ä»¶ä¸­ï¼ˆé€šè¿‡ dump å‡½æ•°ï¼‰
   - ï¼ˆä¸è¿‡æ­¤å¤„æœ‰ä¸ªå¾…ä¼˜åŒ–çš„ç‚¹ï¼Œé¿å…è¯¥ json æ–‡ä»¶è¢«æ¶æ„åˆ é™¤ï¼Œè´Ÿè´£ä¼šä¸¢å¤±åŸæœ‰ ip åˆ†é…ä¿¡æ¯ï¼Œå¯¼è‡´åç»­åˆ†é… ip ä¼šæœ‰é‡å¤ï¼Œä»è€Œå¯¼è‡´ä¸åŒå®¹å™¨æœ‰ç›¸åŒ ipï¼Œé€ æˆé€šä¿¡å†²çªï¼‰
   - å¯»æ‰¾bitmapä¸­ç©ºçš„ä½ç½®ï¼ˆå°±æ˜¯å­—ç¬¦ä¸º0çš„ä½ç½®ï¼‰ï¼Œé‡åˆ°ç¬¬ä¸€ä¸ª0å­—ç¬¦å³ä¸ºå¾…åˆ†é…ipï¼Œæ ¹æ® subnet çš„é¦– ipï¼Œè®¡ç®—æœŸä¸é¦–ipçš„å·®å€¼ï¼Œæ ¹æ®è¯¥å·®å€¼ï¼Œå°† bitmap å¯¹åº”çš„ index è®¾ç½®ä¸º 1ï¼Œè¡¨ç¤ºè¯¥ ip å·²åˆ†é…ï¼ˆè¯¥ä¿¡æ¯ä¼šé€šè¿‡ dump å‡½æ•°æ›´æ–°åˆ°å®¿ä¸»æœºå¯¹åº” json æ–‡ä»¶ä¸­ï¼‰
5. Release å‡½æ•°ï¼Œé‡Šæ”¾ip
   - load åŠ è½½ ip bitmap ä¿¡æ¯ï¼Œä» json æ–‡ä»¶ä¸­è¯»å–
   - æ ¹æ® ip åæŸ¥å…¶åœ¨ bitmap ä¸­çš„ä½ç½®ï¼Œå°±æ˜¯ç”¨ ip - ç½‘æ®µé¦– ip = å·®å€¼ï¼Œå·®å€¼å°±æ˜¯ä¸‹æ ‡ï¼Œå°†å…¶å¯¹åº”çš„å­—ç¬¦æ”¹ä¸º0 ï¼ˆè¡¨ç¤ºé‡Šæ”¾æ­¤ ipï¼‰
   - dump æŒä¹…åŒ– ip bitmap ä¿¡æ¯ï¼Œå­˜åˆ° json æ–‡ä»¶ä¸­

### 1.2 æµ‹è¯•

``` sh
# æµ‹è¯•åˆ†é… ip
root@ubuntu20:/go-code/my-docker/pkg/network# go test -v -run TestAllocate
=== RUN   TestAllocate
INFO[0000] Try load Network-IPAM-ConfigFile: /var/lib/mydocker/network/ipam/subnet.json
    ipam_test.go:16: alloc ip: 192.168.0.1
--- PASS: TestAllocate (0.00s)
PASS
ok  	github.com/oceanweave/my-docker/pkg/network	0.001s
root@ubuntu20:/go-code/my-docker/pkg/network#
# ipåˆ†é…å›¾ï¼Œå·²åˆ†é…çš„ ip ä½ç½®ç½®ä¸º 1
root@ubuntu20:/go-code/my-docker/pkg/network# cat /var/lib/mydocker/network/ipam/subnet.json
{"192.168.0.0/24":"100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"}
# æµ‹è¯•å›æ”¶ ip
root@ubuntu20:/go-code/my-docker/pkg/network# go test -v -run TestRelease
=== RUN   TestRelease
--- PASS: TestRelease (0.00s)
PASS
ok  	github.com/oceanweave/my-docker/pkg/network	0.001s
root@ubuntu20:/go-code/my-docker/pkg/network#
# ip å›æ”¶ï¼Œå·²å›æ”¶çš„ ip ä½ç½®ç½®ä¸º 0
root@ubuntu20:/go-code/my-docker/pkg/network# cat /var/lib/mydocker/network/ipam/subnet.json
{"192.168.0.0/24":"000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"}
```

## 2 | åˆ›å»º bridgeã€é…ç½® iptables ç­‰

### 2.1 å®ç°è¿‡ç¨‹

1. Create æ ¹æ®å­ç½‘ä¿¡æ¯åˆ›å»º Bridge è®¾å¤‡å¹¶åˆå§‹åŒ–

   - ``` sh
     # 1. åˆ›å»ºç½‘æ¡¥
     sudo brctl addbr br0
     # 2. ä¸ºbridgeåˆ†é…IPåœ°å€ï¼Œæ¿€æ´»ä¸Šçº¿
     sudo ip addr add 172.18.0.1/24 dev br0
     # 3. å¯åŠ¨ç½‘æ¡¥è®¾å¤‡
     sudo ip link set br0 up
     # 4. é…ç½® nat è§„åˆ™è®©å®¹å™¨å¯ä»¥è®¿é—®å¤–ç½‘ï¼Œ SNAT å°†æºip  172.18.0.0/24 è½¬ä¸º å®¿ä¸»æœºip
     # è¿™æ¡å‘½ä»¤å¯ä»¥ç®€å•ç†è§£ä¸ºï¼š ç¬¦åˆè¯¥ç½‘æ®µï¼Œå»å¾€ br0 ç½‘æ¡¥çš„æµé‡ä¸éœ€è¦è¿›è¡Œ SNATï¼ˆä¹Ÿå°±æ˜¯å®¹å™¨ç½‘æ¡¥å†…éƒ¨ä¸éœ€è¦è¿›è¡Œ SNAT)
     sudo iptables -t nat -A POSTROUTING -s 172.18.0.0/24 -o eth0 -j MASQUERADE
     # å¦‚æœæƒ³è®© 172.18.0.0/24 ç½‘æ®µçš„è®¾å¤‡ åªèƒ½é€šè¿‡ eth0 è®¿é—®å¤–ç½‘ï¼Œå¯ä»¥æ›´æ˜ç¡®åœ°æŒ‡å®š
     sudo iptables -t nat -A POSTROUTING -s 172.18.0.0/24 -o eth0 -j MASQUERADE
     ```

2. Delete åˆ é™¤å¯¹åº”åç§°çš„ Bridge è®¾å¤‡å³å¯

   - ``` sh
     # 1. åˆ é™¤ç½‘æ¡¥
     ip link del br0
     # 2. åˆ é™¤ iptables(å¾…åšï¼Œç›®å‰ä»£ç ä¸­æœªåŒ…å«) 
     iptables -t nat -D POSTROUTING -s 172.18.0.0/24 -o eth0 -j MASQUERADE
     ```

3. Connect åˆ›å»º veth pair å¯¹

   - ``` sh
     # 1. åˆ›å»º Veth è®¾å¤‡ â€”â€” veth1ï¼ˆå®¿ä¸»æœºç«¯ï¼‰cif-veth1ï¼ˆå®¹å™¨ç«¯ï¼‰
     ip link add veth1 type veth peer name cif-veth1
     # 2. ç»‘å®š veth1 åˆ° Bridge
     ip link set veth1 master br0
     # 3. å¯åŠ¨ veth1ï¼ˆå®¿ä¸»æœºç«¯ï¼‰â€”â€” Go ä»£ç çš„ netlink.LinkSetUp() åªæ‰§è¡Œäº†è¿™ä¸€æ¡å‘½ä»¤ã€‚
     ip link set veth1 up
     
     # 4. å¯åŠ¨ cif-veth1ï¼ˆå®¹å™¨ç«¯ï¼‰â€”â€” æ­¤å¤„æœªå¯åŠ¨ï¼ŒGo ä»£ç ä¸­æ²¡æœ‰è¿™ä¸ªæ“ä½œï¼Œæ‰€ä»¥ å®¹å™¨ç«¯ veth è®¾å¤‡é»˜è®¤æ˜¯ DOWN çŠ¶æ€
     ip link set cif-veth1 up
     ```

4. Disconnect åˆ é™¤ verh pair å¯¹

   - ``` sh
     # 1. è·å– Veth è®¾å¤‡
     ip link show veth1
     # 2. è§£é™¤ Veth è®¾å¤‡ä¸ Bridge çš„ç»‘å®š
     ip link set veth1 nomaster
     # 3. åˆ é™¤ Veth è®¾å¤‡ â€”â€” Veth è®¾å¤‡æ˜¯æˆå¯¹çš„ï¼Œè¿™ä¼šå¯¼è‡´å®ƒçš„å¯¹ç«¯ cif-veth1 ä¹Ÿè¢«åˆ é™¤
     ip link delete veth1
     ```

### 2.2 æµ‹è¯•

#### 2.2.1 æµ‹è¯•ç½‘æ¡¥å’Œ iptables åˆ›å»º

``` sh
# 1. æµ‹è¯• Create å‡½æ•°ï¼Œ
root@ubuntu20:/go-code/my-docker/pkg/network# ip link show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: enp0s5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
    link/ether 00:1c:42:1d:ce:71 brd ff:ff:ff:ff:ff:ff
root@ubuntu20:/go-code/my-docker/pkg/network#
root@ubuntu20:/go-code/my-docker/pkg/network# go test -v -run TestBridgeNetworkDriver_Create
=== RUN   TestBridgeNetworkDriver_Create
    bridge_driver_test.go:16: create network: &{testbridge 192.168.0.0/24 bridge}
--- PASS: TestBridgeNetworkDriver_Create (0.02s)
PASS
ok  	github.com/oceanweave/my-docker/pkg/network	0.017s
# æŸ¥çœ‹åˆ°æ–°åˆ›å»ºçš„ç½‘æ¡¥ testbridge
root@ubuntu20:/go-code/my-docker/pkg/network# ip link show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: enp0s5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
    link/ether 00:1c:42:1d:ce:71 brd ff:ff:ff:ff:ff:ff
4: testbridge: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/ether 1e:58:54:8e:03:dd brd ff:ff:ff:ff:ff:ff
# æŸ¥çœ‹ bridge ä¸Šé…ç½®çš„ nat iptables è§„åˆ™
root@ubuntu20:/go-code/my-docker/pkg/network# iptables-save | grep testbridge
-A POSTROUTING -s 192.168.0.0/24 ! -o testbridge -j MASQUERADE


```

#### 2.2.2 æµ‹è¯•ç½‘æ¡¥åˆ é™¤å’Œ iptables æ¸…ç†

``` sh
# æµ‹è¯• Delete å‡½æ•°
root@ubuntu20:/go-code/my-docker/pkg/network# go test -v -run TestBridgeNetworkDriver_Delete
=== RUN   TestBridgeNetworkDriver_Delete
    bridge_driver_test.go:30: delete network: testbridge
--- PASS: TestBridgeNetworkDriver_Delete (0.05s)
PASS
ok  	github.com/oceanweave/my-docker/pkg/network	0.052s
# æˆåŠŸåˆ é™¤ç½‘æ¡¥
root@ubuntu20:/go-code/my-docker/pkg/network# ip link show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: enp0s5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
    link/ether 00:1c:42:1d:ce:71 brd ff:ff:ff:ff:ff:ff
# ä½†æ˜¯ç›®å‰æ²¡æœ‰æ¸…ç† iptables ï¼ˆåç»­å¾…åšï¼‰
root@ubuntu20:/go-code/my-docker/pkg/network# iptables-save | grep testbridge
-A POSTROUTING -s 192.168.0.0/24 ! -o testbridge -j MASQUERADE
# æ‰‹åŠ¨æ¸…ç† iptables è§„åˆ™
root@ubuntu20:/go-code/my-docker/pkg/network# iptables -t nat -D POSTROUTING -s 192.168.0.0/24 ! -o testbridge -j MASQUERADE
root@ubuntu20:/go-code/my-docker/pkg/network# iptables-save | grep testbridge
root@ubuntu20:/go-code/my-docker/pkg/network#
```

#### 2.2.3 æµ‹è¯•åˆ›å»º veth-pair å¹¶åŠ å…¥åˆ°ç½‘æ¡¥

``` sh
root@ubuntu20:/go-code/my-docker/pkg/network# ip link show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: enp0s5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
    link/ether 00:1c:42:1d:ce:71 brd ff:ff:ff:ff:ff:ff
# 1. å…ˆåˆ›å»ºç½‘æ¡¥
root@ubuntu20:/go-code/my-docker/pkg/network# go test -v -run TestBridgeNetworkDriver_Create
=== RUN   TestBridgeNetworkDriver_Create
    bridge_driver_test.go:16: create network: &{testbridge 192.168.0.0/24 bridge}
--- PASS: TestBridgeNetworkDriver_Create (0.00s)
PASS
# 2. åˆ›å»º veth-pair å¹¶åŠ å…¥åˆ°ç½‘æ¡¥  æµ‹è¯• Connect å‡½æ•°
ok  	github.com/oceanweave/my-docker/pkg/network	0.006s
root@ubuntu20:/go-code/my-docker/pkg/network# go test -v -run TestBridgeNetworkDriver_Connect
=== RUN   TestBridgeNetworkDriver_Connect
--- PASS: TestBridgeNetworkDriver_Connect (0.00s)
PASS
ok  	github.com/oceanweave/my-docker/pkg/network	0.006s
root@ubuntu20:/go-code/my-docker/pkg/network# ip link show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: enp0s5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
    link/ether 00:1c:42:1d:ce:71 brd ff:ff:ff:ff:ff:ff
5: testbridge: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN mode DEFAULT group default qlen 1000
    link/ether e6:56:90:25:24:d2 brd ff:ff:ff:ff:ff:ff
# veth-pair å®¹å™¨ç«¯
6: cif-testc@testc: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 4e:c2:b3:4b:4b:43 brd ff:ff:ff:ff:ff:ff
# veth-pair å®¿ä¸»æœºç«¯  ç»‘å®šåˆ°ç½‘æ¡¥  master  testbridge
# veth-pair å®¿ä¸»æœºç«¯å‘½åå– å®¹å™¨ id å‰äº”ä½ï¼ˆæ­¤å¤„æµ‹è¯•ï¼Œå®¹å™¨idå–åä¸ºtestcontainer,å› æ­¤å‰äº”ä½æ˜¯ testcï¼‰
# veth-pair å®¹å™¨ç«¯å‘½å å‰é¢åŠ  cif- å› æ­¤ä¸º cif-testc
7: testc@cif-testc: <NO-CARRIER,BROADCAST,MULTICAST,UP,M-DOWN> mtu 1500 qdisc noqueue master testbridge state LOWERLAYERDOWN mode DEFAULT group default qlen 1000
    link/ether e6:56:90:25:24:d2 brd ff:ff:ff:ff:ff:ff
```

#### 2.2.4 æµ‹è¯•

``` sh
6: cif-testc@testc: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 4e:c2:b3:4b:4b:43 brd ff:ff:ff:ff:ff:ff
7: testc@cif-testc: <NO-CARRIER,BROADCAST,MULTICAST,UP,M-DOWN> mtu 1500 qdisc noqueue master testbridge state LOWERLAYERDOWN mode DEFAULT group default qlen 1000
    link/ether e6:56:90:25:24:d2 brd ff:ff:ff:ff:ff:ff
root@ubuntu20:/go-code/my-docker/pkg/network# go test -v -run TestBridgeNetworkDriver_Disconnect
=== RUN   TestBridgeNetworkDriver_Disconnect
--- PASS: TestBridgeNetworkDriver_Disconnect (0.02s)
PASS
ok  	github.com/oceanweave/my-docker/pkg/network	0.022s
root@ubuntu20:/go-code/my-docker/pkg/network# ip link show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: enp0s5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
    link/ether 00:1c:42:1d:ce:71 brd ff:ff:ff:ff:ff:ff
5: testbridge: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN mode DEFAULT group default qlen 1000
    link/ether 00:00:00:00:00:00 brd ff:ff:ff:ff:ff:ff
6: cif-testc@testc: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 4e:c2:b3:4b:4b:43 brd ff:ff:ff:ff:ff:ff
# å¯ä»¥çœ‹åˆ°ï¼Œä¹‹å‰çš„ master testbridge å±æ€§ä¸è§äº†ï¼Œè¯´æ˜è§£ç»‘æˆåŠŸ
7: testc@cif-testc: <NO-CARRIER,BROADCAST,MULTICAST,UP,M-DOWN> mtu 1500 qdisc noqueue state LOWERLAYERDOWN mode DEFAULT group default qlen 1000
    link/ether e6:56:90:25:24:d2 brd ff:ff:ff:ff:ff:ff
```



### 2.3 linux çŸ¥è¯†

#### 2.3.1 linux ç½‘ç»œè®¾å¤‡ç´¢å¼•å·é€’å¢

- Linux `ifindex`ï¼ˆè®¾å¤‡ç´¢å¼•ï¼‰æ˜¯é€’å¢çš„ï¼Œå³ä½¿è®¾å¤‡è¢«åˆ é™¤ï¼Œä¹Ÿä¸ä¼šé‡å¤ä½¿ç”¨å·²åˆ†é…çš„ç¼–å·ã€‚
- è¿™æ˜¯ä¸€ç§ Linux è®¾å¤‡ç®¡ç†çš„è®¾è®¡ï¼Œä»¥é˜²æ­¢çŸ­æ—¶é—´å†…ç¼–å·é‡å¤å¸¦æ¥çš„é—®é¢˜ã€‚

``` sh
# æµ‹è¯• åˆ›å»º å’Œ åˆ é™¤ï¼Œå‘ç°åˆ†é…çš„è®¾å¤‡ç´¢å¼•å· ä»æ˜¯é€’å¢
# åˆ›å»º
ip link add testbridge type bridge
ip link show
# åˆ é™¤é‡å»º  ä½ ä¼šå‘ç° ifindex ä»ç„¶ä¼šé€’å¢ï¼Œè€Œä¸ä¼šå›åˆ°ä¹‹å‰åˆ é™¤çš„ç¼–å·ã€‚
ip link del newbridge
ip link add testbridge type bridge
ip link show


root@ubuntu20:/go-code/my-docker/pkg/network# ip link show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: enp0s5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
    link/ether 00:1c:42:1d:ce:71 brd ff:ff:ff:ff:ff:ff
3: testbridge: <BROADCAST,MULTICAST> mtu 1500 qdisc noqueue state DOWN mode DEFAULT group default qlen 1000
    link/ether a6:d8:02:0c:94:7f brd ff:ff:ff:ff:ff:ff
root@ubuntu20:/go-code/my-docker/pkg/network# ip link del testbridge

root@ubuntu20:/go-code/my-docker/pkg/network# ip link show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: enp0s5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
    link/ether 00:1c:42:1d:ce:71 brd ff:ff:ff:ff:ff:ff
4: testbridge: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/ether 1e:58:54:8e:03:dd brd ff:ff:ff:ff:ff:ff

# ä¸ºä»€ä¹ˆ testbridge å˜æˆäº† 4ï¼Ÿ
ä½ æœ€åˆåˆ›å»ºäº† testbridgeï¼Œç³»ç»Ÿç»™å®ƒåˆ†é…äº† ifindex = 3ã€‚
ä½ æ‰§è¡Œäº† ip link del testbridgeï¼Œåˆ é™¤äº† testbridgeï¼Œä½†ç¼–å· 3 ä¸ä¼šè¢«å¤ç”¨ã€‚
ä½ é‡æ–°åˆ›å»º testbridge æ—¶ï¼Œç³»ç»Ÿä¼šä½¿ç”¨ä¸‹ä¸€ä¸ªå¯ç”¨çš„ç¼–å·ï¼Œä¹Ÿå°±æ˜¯ 4ã€‚
Linux è¿™æ ·è®¾è®¡æ˜¯ä¸ºäº†ï¼š

é¿å…çŸ­æ—¶é—´å†…åˆ›å»º/åˆ é™¤è®¾å¤‡æ—¶ï¼Œæ—§çš„ ifindex ä»è¢«ä½¿ç”¨å¯¼è‡´å†²çªã€‚
æä¾›æ›´å¥½çš„ç½‘ç»œè®¾å¤‡ç®¡ç†ï¼Œé˜²æ­¢æŸäº›ç¨‹åºè¯¯ç”¨å·²åˆ é™¤è®¾å¤‡çš„ç¼–å·ã€‚
```

#### 2.3.2 æŸ¥çœ‹ iptables è§„åˆ™

è¦æŸ¥çœ‹ `iptables` ä¸­å…³äº `testbridge` çš„è§„åˆ™ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

##### **1. æŸ¥çœ‹ NAT è§„åˆ™**ï¼ˆå¦‚æœ `testbridge` ä½œä¸º NAT è®¾å¤‡ï¼‰

```sh
sudo iptables -t nat -L -v | grep testbridge
```

æˆ–è€…ï¼š

```sh
sudo iptables -t nat -L -v --line-numbers
```

##### **2. æŸ¥çœ‹ FORWARD è§„åˆ™**ï¼ˆå¦‚æœ `testbridge` å½±å“æ•°æ®åŒ…è½¬å‘ï¼‰

```sh
sudo iptables -t filter -L FORWARD -v | grep testbridge
```

##### **3. æŸ¥çœ‹æ‰€æœ‰è§„åˆ™**ï¼ˆæŸ¥æ‰¾ `testbridge` ç›¸å…³çš„æ‰€æœ‰è§„åˆ™ï¼‰

```sh
sudo iptables-save | grep testbridge
```

##### **4. å¦‚æœä½¿ç”¨ `nftables`ï¼ˆæ–°çš„é˜²ç«å¢™æ¡†æ¶ï¼‰**

å¦‚æœä½ çš„ç³»ç»Ÿä½¿ç”¨çš„æ˜¯ `nftables` è€Œä¸æ˜¯ `iptables`ï¼Œå¯ä»¥ä½¿ç”¨ï¼š

```sh
sudo nft list ruleset | grep testbridge
```

**å¦‚æœ `iptables` è§„åˆ™ä¸­æ²¡æœ‰ `testbridge` ç›¸å…³æ¡ç›®ï¼Œè¯´æ˜å®ƒå¯èƒ½æ²¡æœ‰è¢« `iptables` ç›´æ¥ç®¡ç†ï¼Œæˆ–è€…è§„åˆ™åœ¨ `nftables` ä¸­ã€‚**

#### 2.3.3 åˆ é™¤ iptables è§„åˆ™

``` sh
$ iptables-save | grep testbridge
-A POSTROUTING -s 192.168.0.0/24 ! -o testbridge -j MASQUERADE
```

è¦åˆ é™¤è¿™æ¡ `iptables` è§„åˆ™ï¼Œä½ å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

##### **æ–¹æ³• 1ï¼šä½¿ç”¨ `iptables -D`ï¼ˆæ¨èï¼‰**

`iptables -D` ç”¨äºåˆ é™¤ä¸€æ¡æŒ‡å®šçš„è§„åˆ™ã€‚å¦‚æœä½ èƒ½ç¡®å®šå®ƒçš„å®Œæ•´è§„åˆ™å†…å®¹ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œï¼š

```sh
iptables -t nat -D POSTROUTING -s 192.168.0.0/24 ! -o testbridge -j MASQUERADE
```

------

##### **æ–¹æ³• 2ï¼šæŸ¥çœ‹è§„åˆ™ç¼–å·ååˆ é™¤**

å¦‚æœä¸Šé¢çš„å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼ˆä¾‹å¦‚è§„åˆ™å‚æ•°ä¸å®Œå…¨åŒ¹é…ï¼‰ï¼Œå¯ä»¥å…ˆ**åˆ—å‡º `POSTROUTING` è§„åˆ™çš„ç¼–å·**ï¼Œç„¶åæŒ‰ç¼–å·åˆ é™¤ï¼š

###### **1. åˆ—å‡º `POSTROUTING` è§„åˆ™ç¼–å·**

```sh
iptables -t nat -L POSTROUTING --line-numbers
```

ç¤ºä¾‹è¾“å‡ºï¼š

```
Chain POSTROUTING (policy ACCEPT)
num  target     prot opt source        destination  
1    MASQUERADE all  --  192.168.0.0/24 ! testbridge 
```

**è¿™é‡Œç¬¬ 1 è¡Œï¼ˆnum = 1ï¼‰æ˜¯è¦åˆ é™¤çš„è§„åˆ™**ã€‚

###### **2. æŒ‰ç¼–å·åˆ é™¤**

```sh
iptables -t nat -D POSTROUTING 1
```

ï¼ˆå¦‚æœè§„åˆ™æ’åœ¨ç¬¬ 2 è¡Œï¼Œæ”¹ä¸º `iptables -t nat -D POSTROUTING 2`ï¼‰

------

##### **æ–¹æ³• 3ï¼šç¼–è¾‘ `iptables-save` å¹¶è¿˜åŸ**

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ `iptables-save` æŒä¹…åŒ–è§„åˆ™ï¼Œå¯ä»¥æ‰‹åŠ¨ç¼–è¾‘åé‡æ–°åŠ è½½ï¼š

###### **1. å¤‡ä»½å½“å‰è§„åˆ™**

```sh
iptables-save > /tmp/iptables-backup.rules
```

###### **2. ç¼–è¾‘è§„åˆ™æ–‡ä»¶**

```sh
vim /tmp/iptables-backup.rules
```

æ‰¾åˆ°ï¼š

```
-A POSTROUTING -s 192.168.0.0/24 ! -o testbridge -j MASQUERADE
```

åˆ é™¤è¿™ä¸€è¡Œåä¿å­˜ã€‚

###### **3. é‡æ–°åŠ è½½è§„åˆ™**

```sh
iptables-restore < /tmp/iptables-backup.rules
```

------

##### **æ–¹æ³• 4ï¼šæ¸…ç©º `POSTROUTING` è§„åˆ™ï¼ˆä¸æ¨èï¼Œå½±å“æ‰€æœ‰è§„åˆ™ï¼‰**

å¦‚æœæƒ³**æ¸…ç©ºæ•´ä¸ª `POSTROUTING` è§„åˆ™é“¾**ï¼ˆä¸åªæ˜¯ `testbridge` ç›¸å…³è§„åˆ™ï¼‰ï¼Œå¯ä»¥æ‰§è¡Œï¼š

```sh
iptables -t nat -F POSTROUTING
```

âš  **æ³¨æ„**ï¼šæ­¤æ–¹æ³•ä¼šåˆ é™¤ `POSTROUTING` é‡Œçš„æ‰€æœ‰è§„åˆ™ï¼Œä¸åªæ˜¯ `testbridge` ç›¸å…³çš„ã€‚

------

##### **æ€»ç»“**

- æ¨è

  æ–¹æ³• 1ï¼š

  ```sh
  iptables -t nat -D POSTROUTING -s 192.168.0.0/24 ! -o testbridge -j MASQUERADE
  ```

- å¦‚æœå¤±è´¥ï¼Œä½¿ç”¨æ–¹æ³• 2ï¼Œå…ˆç”¨ `iptables -L --line-numbers` è·å–ç¼–å·ï¼Œç„¶å `iptables -D` åˆ é™¤ã€‚

- å¦‚æœè§„åˆ™éœ€è¦æŒä¹…åŒ–ï¼Œä½¿ç”¨ `iptables-save` å’Œ `iptables-restore` ç¼–è¾‘è§„åˆ™ã€‚





### 2.4 go çŸ¥è¯†

``` sh
# æŠ¥é”™
$ go test -v run TestBridgeNetworkDriver_Create
cannot find package "." in:
	/go-code/my-docker/vendor/run
cannot find package "." in:
	/go-code/my-docker/vendor/TestBridgeNetworkDriver_Create
```

#### **æ­£ç¡®çš„ç”¨æ³•**

##### **æ–¹æ³• 1ï¼šåŠ  `-` ç¬¦å·**

```
sh


å¤åˆ¶ç¼–è¾‘
go test -v -run TestBridgeNetworkDriver_Create
```

âœ… **`-run` é€‰é¡¹ç”¨äºåŒ¹é…æµ‹è¯•å‡½æ•°çš„åç§°**ï¼Œ`TestBridgeNetworkDriver_Create` æ˜¯ä½ è¦æ‰§è¡Œçš„æµ‹è¯•å‡½æ•°ã€‚

##### **æ–¹æ³• 2ï¼šæŒ‡å®šåŒ…è·¯å¾„**

å¦‚æœ `TestBridgeNetworkDriver_Create` åœ¨ `network` åŒ…ä¸‹ï¼š

```
sh


å¤åˆ¶ç¼–è¾‘
go test -v -run TestBridgeNetworkDriver_Create ./network
```

âœ… è¿™æ · `go test` ä¼šåœ¨ `./network` ç›®å½•ä¸‹è¿è¡Œæµ‹è¯•ã€‚

##### **æ–¹æ³• 3ï¼šè¿è¡Œæ‰€æœ‰æµ‹è¯•**

å¦‚æœä½ ä¸ç¡®å®šå…·ä½“çš„ `-run` é€‰é¡¹æ ¼å¼ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œï¼š

```
sh


å¤åˆ¶ç¼–è¾‘
go test -v ./...
```

âœ… è¿™æ ·ä¼šæ‰§è¡Œæ‰€æœ‰æµ‹è¯•å‡½æ•°ï¼Œçœ‹çœ‹ `TestBridgeNetworkDriver_Create` æ˜¯å¦åœ¨å…¶ä¸­ã€‚

##### **æ€»ç»“**

- **é”™è¯¯çš„å†™æ³•**ï¼š`go test -v run TestBridgeNetworkDriver_Create`ï¼ˆç¼ºå°‘ `-`ï¼‰
- **æ­£ç¡®çš„å†™æ³•**ï¼š`go test -v -run TestBridgeNetworkDriver_Create`
- **å¦‚æœåœ¨å­åŒ…**ï¼š`go test -v -run TestBridgeNetworkDriver_Create ./network`
- **æ‰§è¡Œæ‰€æœ‰æµ‹è¯•**ï¼š`go test -v ./...`

è¿™æ ·å°±èƒ½æ­£ç¡®è¿è¡Œä½ çš„æµ‹è¯•å‡½æ•°äº†ï¼ğŸš€

