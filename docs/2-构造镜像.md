## 参考

- [从零开始写 Docker(四)---使用 pivotRoot 切换 rootfs 实现文件系统隔离 -](https://www.lixueduan.com/posts/docker/mydocker/04-change-rootfs-by-pivot-root/)



## 1 | 更改 rootfs（对应 image-rootfs 分支）

1. 准备 rootfs，从现有 busybox 镜像中导出文件系统

    - ``` sh
     docker pull busybox
     # 执行一个交互式命令，让容器能一直后台运行
     docker run -d busybox top
     # 拿到刚创建的容器的 Id
     containerId=$(docker ps --filter "ancestor=busybox:latest"|grep -v IMAGE|awk '{print $1}')
     echo "containerId" $containerId
     # export 从容器导出
     docker export -o busybox.tar $containerId
     
     mkdir busybox
     tar -xvf busybox.tar -C busybox/
     ```

2. 挂载 rootfs，使用 pivot_root 系统调用，将旧的 rootfs 改为新的 rootfs（busybox 文件系统）

    - 注意 pivot_root 系统调用，需要新旧 rootfs 在不同的文件系统中，因此通过 bind-mount 在老的 rootfs 中新建一个挂载点（表现为两个不同的文件系统）
    - 之后创建一个目录，用于 旧rootfs 挂载，便于之后清理旧 rootfs

3. 利用 cmd.Dir 参数，为 init 命令配置工作目录（新 rootfs，注意此处有坑，应该为宿主机上的 busybox 目录路径），这样便于后续进行 新旧 rootfs 的切换