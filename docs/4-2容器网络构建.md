## å½“å‰é…ç½®ç›®å½•

``` sh
# ipam é»˜è®¤ç›®å½•
/var/lib/mydocker/network/ipam/
# ipam json æ–‡ä»¶ â€”â€”  subnetåç§°å’Œå¯¹åº”çš„bitmapå½¢å¼çš„ ip åˆ†é…æƒ…å†µ
cat /var/lib/mydocker/network/ipam/subnet.json

# network é»˜è®¤ç›®å½•
/var/lib/mydocker/network/network
# æ–‡ä»¶åç§°å°±æ˜¯å¯¹åº”çš„ network åç§°ï¼Œè®°å½•ï¼ˆç½‘ç»œåç§°ï¼Œipæ®µã€é©±åŠ¨åç§°ï¼‰ï¼Œå¦‚ testbr0 
cat /var/lib/mydocker/network/network/testbr0
```



## 3. æµ‹è¯•åˆ›å»ºç½‘æ¡¥åˆ†é… ip å’Œåˆ é™¤ç½‘æ¡¥

### å®ç°æµç¨‹

1. createï¼šåˆ›å»ºç½‘ç»œ

   - é¦–å…ˆæ˜¯ä½¿ç”¨ IPAM åˆ†é… IPï¼ˆæ³¨æ„ç½‘æ®µå‰åä¸å¯åˆ†é…ï¼Œå¦‚ 192.168.0.0/24  ä¸­ 192.168.0.0ï¼ˆä¸€èˆ¬ç”¨äºè¡¨ç¤ºç½‘æ®µï¼Œé…ç½®åˆ°è·¯ç”±è¡¨ä¸­ï¼‰ï¼Œ192.168.0.255 è¡¨ç¤ºå¹¿æ’­åœ°å€ï¼›æ‰€ä»¥ç½‘å…³IP ä¸€èˆ¬ä¸ºå¯åˆ†é…çš„ç¬¬ä¸€ä½ï¼Œå°±æ˜¯ 192.168.0.1/24ï¼‰

   - ç„¶åæ ¹æ® driver æ‰¾åˆ°å¯¹åº”çš„ NetworkDriver å¹¶åˆ›å»ºç½‘ç»œï¼ˆè¿™é‡Œåªå®ç°äº† bridge driverï¼Œæ‰€ä»¥é‡‡ç”¨æ­¤ driver åˆ›å»ºç½‘ç»œè®¾å¤‡å¹¶é…ç½®ä¸Šç½‘å…³IPï¼‰

   - æœ€åå°†ç½‘ç»œä¿¡æ¯ä¿å­˜åˆ°æ–‡ä»¶ï¼ˆå½“å‰é»˜è®¤å­˜å‚¨è·¯å¾„ä¸º `/var/lib/mydocker/network/network/`,æ–‡ä»¶åç§°ä¸ºç½‘ç»œåç§°ï¼‰
   - ![åˆ›å»ºç½‘ç»œ](imgs/4-2å®¹å™¨ç½‘ç»œæ„å»º/åˆ›å»ºç½‘ç»œ.png)

2. listï¼šæŸ¥çœ‹å½“å‰æ‰€æœ‰ç½‘ç»œä¿¡æ¯

   - æ‰«æç½‘ç»œé…ç½®çš„ç›®å½•`/var/lib/mydocker/network/network/`æ‹¿åˆ°æ‰€æœ‰çš„ç½‘ç»œé…ç½®ä¿¡æ¯å¹¶æ‰“å°å³å¯

3. removeï¼šåˆ é™¤ç½‘ç»œ

   - å…ˆè°ƒç”¨ IPAM å»é‡Šæ”¾ç½‘ç»œæ‰€å ç”¨çš„ç½‘å…³ IP
   - ç„¶åè°ƒç”¨ç½‘ç»œé©±åŠ¨å»åˆ é™¤è¯¥ç½‘ç»œåˆ›å»ºçš„ä¸€äº›è®¾å¤‡ä¸é…ç½®
   - æœ€ç»ˆä»ç½‘ç»œé…ç½®ç›®å½•ä¸­åˆ é™¤ç½‘ç»œå¯¹åº”çš„é…ç½®æ–‡ä»¶
   - ![åˆ é™¤ç½‘ç»œ](imgs/4-2å®¹å™¨ç½‘ç»œæ„å»º/åˆ é™¤ç½‘ç»œ.png)

### æµ‹è¯•

``` sh
root@dfy-1:/go-code/my-docker#
# 1. ä½¿ç”¨ bridge é©±åŠ¨ï¼Œåˆ›å»ºç½‘ç»œï¼ŒåŒæ—¶æŒ‡å®šç½‘æ®µä¸º 192.168.0.0/24ï¼Œåˆ›å»ºå‡ºçš„ç½‘æ¡¥åç§°ä¸º testbr0
root@dfy-1:/go-code/my-docker# ./my-docker network create --subnet 192.168.0.0/24 --driver bridge testbr0
{"level":"debug","msg":"Allocate IP ... ...","time":"2025-03-13T17:11:17+08:00"}
{"level":"debug","msg":"Dump Network-IPAM-Info to File: /var/lib/mydocker/network/ipam/subnet.json","time":"2025-03-13T17:11:17+08:00"}
{"level":"debug","msg":"Allocate IP Finish â€”â€” subnet: 192.168.0.1/24, get free ip: 192.168.0.1","time":"2025-03-13T17:11:17+08:00"}
{"level":"debug","msg":"initBridge gatewayIP: 192.168.0.1/24","time":"2025-03-13T17:11:17+08:00"}
{"level":"debug","msg":"Dump Network-testbr0-Info to File: /var/lib/mydocker/network/network/testbr0","time":"2025-03-13T17:11:17+08:00"}
# æŸ¥çœ‹ ip åˆ†é…æƒ…å†µï¼Œ192.168.0.0 ç½‘æ®µï¼ˆä¸€èˆ¬é…ç½®åˆ°è·¯ç”±è¡¨ä¸­ï¼‰ 192.168.0.255ï¼ˆå¹¿æ’­åœ°å€ï¼‰ï¼Œè¿™ä¸¤ä¸ª IP é»˜è®¤æ˜¯ä¸åˆ†é…çš„ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä½å’Œæœ€åä¸€ä½é»˜è®¤ç½®ä¸º1
# å› æ­¤åˆ†é…çš„ IP ä¸º 192.168.0.1ï¼Œä¹Ÿå°±æ˜¯ç½‘å…³ IP
root@dfy-1:/go-code/my-docker# cat /var/lib/mydocker/network/ipam/subnet.json
{"192.168.0.0/24":"1100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001"}
# åˆ›å»ºçš„ç½‘ç»œä¿¡æ¯å­˜å‚¨åœ¨å®¿ä¸»æœºä»¥æ­¤ç½‘ç»œå‘½åçš„æ–‡ä»¶ä¸­ï¼Œ ////AA== æ˜¯ base64ç¼–ç ï¼Œè¡¨ç¤º 24
root@dfy-1:/go-code/my-docker# cat /var/lib/mydocker/network/network/testbr0
{"Name":"testbr0","IPRange":{"IP":"192.168.0.1","Mask":"////AA=="},"Driver":"bridge"}root@dfy-1:/go-code/my-docker#
root@dfy-1:/go-code/my-docker#
# å¯ä»¥çœ‹å‡ºï¼Œåˆ›å»ºå‡º ç½‘æ¡¥testbr0
root@dfy-1:/go-code/my-docker# ip link show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: enp0s5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000
    link/ether 00:1c:42:1d:ce:71 brd ff:ff:ff:ff:ff:ff
18: testbr0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
    link/ether 86:d6:cf:f0:55:38 brd ff:ff:ff:ftestbr0
# æŸ¥çœ‹ç½‘æ¡¥ IPï¼Œä½¿æˆ‘ä»¬æƒ³è¦é…ç½®çš„ 192.168.0.1/24ï¼Œåé¢ 192.168.0.255 è¡¨ç¤ºå¹¿æ’­åœ°å€
root@dfy-1:/go-code/my-docker# ip addr show testbr0
18: testbr0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether 86:d6:cf:f0:55:38 brd ff:ff:ff:ff:ff:ff
    inet 192.168.0.1/24 brd 192.168.0.255 scope global testbr0
       valid_lft forever preferred_lft forever
    inet6 fe80::84d6:cfff:fef0:5538/64 scope link
       valid_lft forever preferred_lft forever
root@dfy-1:/go-code/my-docker#
# 2. æŸ¥çœ‹ç½‘ç»œï¼Œç¬¦åˆä¸Šé¢çš„åˆ›å»ºä¿¡æ¯
root@dfy-1:/go-code/my-docker# ./my-docker network list
{"level":"debug","msg":"Try load Network-testbr0-ConfigFile: /var/lib/mydocker/network/network/testbr0","time":"2025-03-13T17:14:29+08:00"}
NAME        IPRange          Driver
testbr0     192.168.0.1/24   bridge

# 3. åˆ é™¤ç½‘ç»œ
root@dfy-1:/go-code/my-docker# ./my-docker network remove testbr0
{"level":"debug","msg":"Try load Network-testbr0-ConfigFile: /var/lib/mydocker/network/network/testbr0","time":"2025-03-13T17:12:06+08:00"}
{"level":"debug","msg":"DeleteNetwork net info: IPRange: 192.168.0.1/24, IP: 192.168.0.1","time":"2025-03-13T17:12:06+08:00"}
{"level":"debug","msg":"Release IP ... ...","time":"2025-03-13T17:12:06+08:00"}
{"level":"debug","msg":"Try load Network-IPAM-ConfigFile: /var/lib/mydocker/network/ipam/subnet.json","time":"2025-03-13T17:12:06+08:00"}
{"level":"debug","msg":"Dump Network-IPAM-Info to File: /var/lib/mydocker/network/ipam/subnet.json","time":"2025-03-13T17:12:06+08:00"}
{"level":"debug","msg":"Release IP Finish â€”â€” subnet: 192.168.0.0/24, release ip: 192.168.0.1","time":"2025-03-13T17:12:06+08:00"}
# IP é‡Šæ”¾æ­£ç¡®
root@dfy-1:/go-code/my-docker# cat /var/lib/mydocker/network/ipam/subnet.json
{"192.168.0.0/24":"1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001"}
# ç½‘ç»œå­˜å‚¨ä¿¡æ¯ä¹Ÿç§»é™¤äº†
root@dfy-1:/go-code/my-docker# cat /var/lib/mydocker/network/network/testbr0
cat: /var/lib/mydocker/network/network/testbr0: No such file or directory
```



## 4. ä¿®å¤ç½‘æ¡¥bug

### 4.1  åˆ›å»ºç½‘æ¡¥è¿‡ç¨‹

1. åˆ›å»ºç½‘æ¡¥è®¾å¤‡

   - ``` sh
     # ip link show
     33: testbridge: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000
         link/ether 96:1f:26:a7:a6:1c brd ff:ff:ff:ff:ff:ff
     ```

2. ç”³è¯· IPï¼Œä¸ºç½‘æ¡¥é…ç½®ç½‘å…³ IPï¼›å¹¶å¯åŠ¨ç½‘æ¡¥è®¾å¤‡ï¼ˆUPçŠ¶æ€è¡¨ç¤º å·²å¯åŠ¨ï¼‰

   - ``` sh
     # æ­¤å¤„ ç½‘æ¡¥IP ä¸º 10.0.0.1/24 
     # ç”±äºæ©ç  24ï¼Œæ‰€ä»¥å¯ä»¥ç®—å‡ºè´Ÿè´£çš„ç½‘æ®µä¸º 10.0.0.0/24 
     # 10.0.0.255 ä¸ºå¹¿æ’­åœ°å€
     root@ubuntu20:/go-code/my-docker# ip addr show testbridge
     33: testbridge: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
         link/ether 96:1f:26:a7:a6:1c brd ff:ff:ff:ff:ff:ff
         inet 10.0.0.1/24 brd 10.0.0.255 scope global testbridge
            valid_lft forever preferred_lft forever
         inet6 fe80::941f:26ff:fea7:a61c/64 scope link
            valid_lft forever preferred_lft forever
     ```

3. æ·»åŠ  iptables SNAT è§„åˆ™ï¼ˆç”¨äºä½¿ç”¨è¯¥ç½‘æ¡¥çš„å®¹å™¨ï¼Œå°†æ•°æ®åŒ…å‘é€åˆ°å¤–ç½‘æ—¶ï¼Œå°†å®¹å™¨ IP è½¬æ¢ä¸º å®¿ä¸»æœº IPï¼‰

   - ``` sh
     # è¡¨ç¤ºéå‘é€åˆ°å½“å‰ç½‘æ¡¥çš„æ•°æ®åŒ…ï¼ˆéç½‘æ¡¥å†…æ•°æ®åŒ…ï¼‰ï¼Œéƒ½è¿›è¡Œ SNAT è½¬æ¢
     # å‡ºå®¿ä¸»æœºæ—¶ï¼Œä¼šç»è¿‡è¯¥é“¾çš„è¿‡æ»¤ï¼Œè¿›è¡Œ SNAT è½¬æ¢ï¼ˆå°†å®¹å™¨ IP è½¬ä¸º å®¿ä¸»æœºIPï¼Œå› ä¸ºå¤–éƒ¨ä¸è®¤è¯†å®¹å™¨ IPï¼Œè‹¥é‡‡ç”¨å®¹å™¨ IP ä¼šå¯¼è‡´å›åŒ…æ”¶ä¸åˆ°ï¼‰
     root@ubuntu20:/go-code/my-docker# iptables-save | grep test
     -A POSTROUTING -s 10.0.0.0/24 ! -o testbridge -j MASQUERADE
     ```

4. æ·»åŠ è·¯ç”±è§„åˆ™ï¼ˆä¸ºäº†å°†å¤–éƒ¨æ•°æ®å›åŒ…æ­£ç¡®è½¬å‘åˆ°å®¹å™¨ä¸­ï¼‰

   - ``` sh
     # ä¸Šé¢è¿›è¡Œ SNAT è½¬æ¢åï¼Œå®¿ä¸»æœºå¯ä»¥æ­£ç¡®æ”¶åˆ°æ•°æ®å›åŒ…ï¼Œå°†å…¶ IP è½¬ä¸ºå®¹å™¨ IPï¼ˆNAT çš„ conntrack æœºåˆ¶ï¼‰
     # conntrack ä¼šè®°å½•å‘é€çš„ä¿¡æ¯ï¼ˆè·Ÿè¸ªäº”å…ƒç»„ï¼ˆæº IPã€æºç«¯å£ã€ç›®æ ‡ IPã€ç›®æ ‡ç«¯å£ã€åè®®ï¼‰ï¼‰ï¼Œè¿›è¡Œè½¬æ¢å’Œåè½¬æ¢
     # å› æ­¤å›åŒ…åˆ°å®¿ä¸»æœºåï¼Œä¼šè½¬ä¸ºå®¹å™¨ IPï¼Œä½†å®¿ä¸»æœºä¸çŸ¥é“å®¹å™¨ IP åœ¨å“ªï¼Ÿ
     # æ­¤æ—¶å°±ä¾èµ–è·¯ç”±äº† â€”â€” éœ€è¦é…ç½®ä¸ªè·¯ç”±ï¼Œå°†æ­¤å®¹å™¨ç½‘æ®µçš„æ•°æ®åŒ…è½¬å‘åˆ°ç½‘æ¡¥ï¼ˆç½‘æ¡¥ä¸Šé€šè¿‡å¹¿æ’­ï¼Œä¼šçŸ¥é“å°†æ•°æ®åŒ…å‘ç»™å“ªä¸ªå®¹å™¨ï¼‰
     # ä¸‹é¢è·¯ç”± å°±æ˜¯è¯´æ˜ å‘é€ç»™ 10.0.0.0/24 ç½‘æ®µçš„æ•°æ®åŒ…ï¼Œå‘åˆ° 10.0.0.1 IPï¼ˆä¹Ÿå°±æ˜¯ç½‘æ¡¥ï¼‰
     root@ubuntu20:/go-code/my-docker# ip r
     default via 10.211.55.1 dev enp0s5 proto dhcp src 10.211.55.3 metric 100
     10.0.0.0/24 dev testbridge proto kernel scope link src 10.0.0.1
     # å¦å¤–éœ€è¦æœ‰ä¸€ç‚¹ï¼Œè¦ååˆ†æ³¨æ„ï¼ï¼ï¼
     # è½¬å‘åˆ°å¤–ç½‘çš„æ•°æ®åŒ…ï¼Œéœ€è¦åœ¨å®¿ä¸»æœºä¸Šå¼€å¯è½¬å‘åŠŸèƒ½ï¼Œå°±æ˜¯æ‰§è¡Œä¸‹é¢å‘½ä»¤
     sysctl net.ipv4.conf.all.forwarding=1
     # æŸ¥çœ‹é…ç½®ç»“æœ 
     root@ubuntu20:/go-code/my-docker# sysctl net.ipv4.conf.all.forwarding
     net.ipv4.conf.all.forwarding = 1
     # é‡ç‚¹ï¼ï¼ï¼ å¼€å¯æ­¤é…ç½®åï¼Œåˆ›å»ºç½‘æ¡¥æ—¶ï¼Œä¼šè‡ªåŠ¨æ·»åŠ ä¸Šé¢çš„è½¬å‘è·¯ç”±ï¼Œå› æ­¤ä¸éœ€è¦åœ¨ä»£ç ä¸­æ‰‹åŠ¨æ·»åŠ è·¯ç”±ï¼ˆä¼šé‡å¤ï¼Œå¯¼è‡´æŠ¥é”™ï¼‰
     # å¦å¤–æ³¨æ„ï¼Œè¯¥åŠŸèƒ½å¼€å¯å‰ï¼Œå·²åˆ›å»ºçš„ç½‘æ¡¥ï¼Œä¸ä¼šäº§ç”Ÿè½¬å‘è·¯ç”±
     # å› æ­¤å·²åˆ›å»ºçš„ç½‘æ¡¥ï¼Œéœ€è¦æ‰‹åŠ¨é…ç½®ä¸Šé¢è·¯ç”±ï¼›æˆ–åˆ é™¤ç½‘æ¡¥è¿›è¡Œé‡å»º
     ```

### 4.2 åˆ é™¤ç½‘æ¡¥è¿‡ç¨‹

1. æ¸…ç†è·¯ç”±è§„åˆ™
2. æ¸…ç†iptables SNAT è§„åˆ™
3. åˆ é™¤ç½‘æ¡¥è®¾å¤‡

### 4.3 iptables ç®€å•ä»‹ç»

- [iptables ä½¿ç”¨æ–¹å¼æ•´ç†](https://blog.konghy.cn/2019/07/21/iptables/)
- [iptablesè¯¦è§£ï¼ˆ1ï¼‰ï¼šiptablesæ¦‚å¿µ](https://www.zsythink.net/archives/1199)

![iptablesæ•°æ®åŒ…æµè½¬æµç¨‹](imgs/4-2å®¹å™¨ç½‘ç»œæ„å»º/iptablesæ•°æ®åŒ…æµè½¬æµç¨‹.png)

![iptableså››è¡¨äº”é“¾](imgs/4-2å®¹å™¨ç½‘ç»œæ„å»º/iptableså››è¡¨äº”é“¾.png)

é“¾(chains)æ˜¯æ•°æ®åŒ…ä¼ è¾“çš„è·¯å¾„ï¼Œå¯¹åº”ç€å‰é¢æåˆ°çš„æŠ¥æ–‡å¤„ç†çš„äº”ä¸ªé˜¶æ®µï¼Œä¹Ÿç›¸å½“äºæ˜¯äº”ä¸ªä¸åŒçš„å…³å¡ï¼š

- **INPUTï¼š** å¤„ç†å…¥ç«™æ•°æ®åŒ…ï¼Œå½“æ¥æ”¶åˆ°è®¿é—®æœ¬æœºåœ°å€çš„æ•°æ®åŒ…(å…¥ç«™)æ—¶ï¼Œåº”ç”¨æ­¤é“¾ä¸­çš„è§„åˆ™
- **OUTPUTï¼š** å¤„ç†å‡ºç«™æ•°æ®åŒ…ï¼Œå½“æœ¬æœºå‘å¤–å‘é€æ•°æ®åŒ…(å‡ºç«™)æ—¶ï¼Œåº”ç”¨æ­¤é“¾ä¸­çš„è§„åˆ™
- **FORWARDï¼š** å¤„ç†è½¬å‘æ•°æ®åŒ…ï¼Œå½“æ¥æ”¶åˆ°éœ€è¦é€šè¿‡æœ¬æœºå‘é€ç»™å…¶ä»–åœ°å€çš„æ•°æ®åŒ…(è½¬å‘)æ—¶ï¼Œåº”ç”¨æ­¤é“¾ä¸­çš„è§„åˆ™
- **PREROUTINGï¼š** åœ¨å¯¹æ•°æ®åŒ…ä½œè·¯ç”±é€‰æ‹©ä¹‹å‰ï¼Œåº”ç”¨æ­¤é“¾ä¸­çš„è§„åˆ™
- **POSTROUTINGï¼š** åœ¨å¯¹æ•°æ®åŒ…ä½œè·¯ç”±é€‰æ‹©ä¹‹åï¼Œåº”ç”¨æ­¤é“¾ä¸­çš„è§„åˆ™

é“¾æ˜¯è§„åˆ™çš„å®¹å™¨ï¼Œä¸€æ¡é“¾ä¸­å¯èƒ½åŒ…å«ç€ä¼—å¤šçš„è§„åˆ™ï¼Œå½“ä¸€ä¸ªæ•°æ®åŒ…åˆ°è¾¾ä¸€ä¸ªé“¾æ—¶ï¼Œiptables å°±ä¼šä»é“¾ä¸­ç¬¬ä¸€æ¡è§„åˆ™å¼€å§‹åŒ¹é…ï¼Œå¦‚æœæ»¡è¶³è¯¥è§„åˆ™çš„æ¡ä»¶ï¼Œç³»ç»Ÿå°±ä¼šæ ¹æ®è¯¥æ¡è§„åˆ™æ‰€å®šä¹‰çš„æ–¹æ³•å¤„ç†è¯¥æ•°æ®åŒ…ï¼Œå¦åˆ™å°†ç»§ç»­åŒ¹é…ä¸‹ä¸€æ¡è§„åˆ™ï¼Œå¦‚æœè¯¥æ•°æ®åŒ…ä¸ç¬¦åˆé“¾ä¸­ä»»ä¸€æ¡è§„åˆ™ï¼Œiptables å°±ä¼šæ ¹æ®è¯¥é“¾é¢„å…ˆå®šä¹‰çš„é»˜è®¤ç­–ç•¥æ¥å¤„ç†æ•°æ®åŒ…ã€‚

INPUT, OUTPUT é“¾æ›´å¤šçš„åº”ç”¨åœ¨æœ¬æœºçš„ç½‘ç»œæ§åˆ¶ä¸­ï¼Œå³ä¸»è¦é’ˆå¯¹æœ¬æœºè¿›å‡ºæ•°æ®çš„å®‰å…¨æ§åˆ¶ã€‚è€Œ FORWARD, PREROUTING, POSTROUTING é“¾æ›´å¤šåœ°åº”ç”¨åœ¨å¯¹æˆ‘çš„ç½‘ç»œæ§åˆ¶ä¸­ï¼Œç‰¹åˆ«æ˜¯æœºå™¨ä½œä¸ºç½‘å…³ä½¿ç”¨æ—¶çš„æƒ…å†µã€‚

è¡¨æ˜¯é“¾çš„å®¹å™¨ï¼Œä¸åŒçš„è¡¨ä¸­åŒ…å«ç€ä¸åŒçš„é“¾ï¼š

**Filter è¡¨** æ˜¯ iptables çš„é»˜è®¤è¡¨ï¼Œå› æ­¤å¦‚æœæ²¡æœ‰æŒ‡å®šè¡¨ï¼Œé‚£ä¹ˆé»˜è®¤æ“ä½œçš„æ˜¯ filter è¡¨ï¼Œå…¶åŒ…å«ä»¥ä¸‹ä¸‰ç§å†…å»ºé“¾ï¼š

- INPUT é“¾ â€“ å¤„ç†æ¥è‡ªå¤–éƒ¨çš„æ•°æ®
- OUTPUT é“¾ â€“ å¤„ç†å‘å¤–å‘é€çš„æ•°æ®
- FORWARD é“¾ â€“ å°†æ•°æ®è½¬å‘åˆ°æœ¬æœºçš„å…¶ä»–ç½‘å¡è®¾å¤‡ä¸Š

**NAT è¡¨** åŒ…å«ä»¥ä¸‹ä¸‰ç§å†…å»ºé“¾ï¼š

- PREROUTING é“¾ â€“ å¤„ç†åˆšåˆ°è¾¾æœ¬æœºå¹¶åœ¨è·¯ç”±è½¬å‘å‰çš„æ•°æ®åŒ…ã€‚å®ƒä¼šè½¬æ¢æ•°æ®åŒ…ä¸­çš„ç›®æ ‡ IP åœ°å€ï¼ˆdestination ip addressï¼‰ï¼Œé€šå¸¸ç”¨äº DNAT(destination NAT)
- POSTROUTING é“¾ â€“ å¤„ç†å³å°†ç¦»å¼€æœ¬æœºçš„æ•°æ®åŒ…ã€‚å®ƒä¼šè½¬æ¢æ•°æ®åŒ…ä¸­çš„æº IP åœ°å€ï¼ˆsource ip addressï¼‰ï¼Œé€šå¸¸ç”¨äº SNATï¼ˆsource NATï¼‰
- OUTPUT é“¾ â€“ å¤„ç†æœ¬æœºäº§ç”Ÿçš„æ•°æ®åŒ…

**Mangle è¡¨** æŒ‡å®šå¦‚ä½•å¤„ç†æ•°æ®åŒ…ã€‚å®ƒèƒ½æ”¹å˜ TCP å¤´ä¸­çš„ QoS ä½ã€‚Mangle è¡¨åŒ…å«äº”ç§å†…å»ºé“¾ï¼šPREROUTING, OUTPUT, FORWARD, INPUT, POSTROUTING.

**Raw è¡¨** åŒ…å«ä¸¤ä¸ªå†…å»ºé“¾ï¼šPREROUTING, OUTPUT.

### 4.4  iptables SNAT å¦‚ä½•æ­£ç¡®å°†å›åŒ…è½¬ä¸ºå®¹å™¨ IP(æ ¹æ® conntrack è®°å½•è¿›è¡Œè½¬æ¢)

å®¹å™¨ IP ç»è¿‡ **SNATï¼ˆSource Network Address Translationï¼‰** è½¬æ¢ä¸ºå®¿ä¸»æœº IP åï¼Œå›åŒ…çš„æ­£ç¡®è½¬æ¢ä¾èµ–äº **NAT æ˜ å°„è¡¨**ï¼Œä¸»è¦ç”± **iptables çš„ conntrack æœºåˆ¶** ç»´æŠ¤ã€‚

------

#### **å¦‚ä½•ç¡®ä¿å›åŒ…æ­£ç¡®è½¬æ¢ä¸ºå®¹å™¨ IPï¼Ÿ**

å½“æ•°æ®åŒ…ä»å®¹å™¨ï¼ˆ`10.0.0.2`ï¼‰å‡ºå»åï¼ŒSNAT è§„åˆ™ä¼šæŠŠæº IP **è½¬æ¢ä¸ºå®¿ä¸»æœº IPï¼ˆå¦‚ `192.168.1.100`ï¼‰**ã€‚å½“ç›®æ ‡æœåŠ¡å™¨ï¼ˆå¤–éƒ¨ IPï¼Œå¦‚ `8.8.8.8`ï¼‰è¿”å›æ•°æ®æ—¶ï¼Œéœ€è¦ç¡®ä¿å›åŒ…èƒ½æ­£ç¡®æ˜ å°„å›å®¹å™¨ã€‚

#### **1. ä¾èµ– `iptables` å’Œ `conntrack`**

SNAT ä¸»è¦ç”± **`POSTROUTING` é“¾** è§„åˆ™å®ç°ï¼š

```sh
iptables -t nat -A POSTROUTING -s 10.0.0.0/24 ! -o testbridge -j MASQUERADE
```

- `-s 10.0.0.0/24` ï¼šåŒ¹é…å®¹å™¨çš„ IP æ®µ
- `! -o testbridge` ï¼šç¡®ä¿æµé‡æ˜¯å‘å¾€å¤–éƒ¨çš„ï¼ˆä¸åœ¨ bridge å†…éƒ¨ï¼‰
- `-j MASQUERADE` ï¼šåŠ¨æ€æ›¿æ¢æº IP ä¸ºå®¿ä¸»æœºå¤–ç½‘ IP

**`conntrack` æœºåˆ¶** è®°å½• NAT è¿æ¥æ˜ å°„ï¼š

```sh
conntrack -L
```

æŸ¥çœ‹æ˜¯å¦æœ‰ï¼š

```
tcp      6 431995 ESTABLISHED src=10.0.0.2 dst=8.8.8.8 sport=50000 dport=443 \
    src=8.8.8.8 dst=192.168.1.100 sport=443 dport=50000 [ASSURED]
```

è¡¨ç¤ºï¼š

- **å‡ºç«™æ—¶**ï¼š10.0.0.2 â†’ 8.8.8.8ï¼Œæº IP æ”¹ä¸º 192.168.1.100
- **å›åŒ…æ—¶**ï¼š8.8.8.8 â†’ 192.168.1.100ï¼Œ`conntrack` è¿˜åŸå› 10.0.0.2

------

#### **2. ç¡®ä¿ `iptables` è§„åˆ™æ­£ç¡®**

æŸ¥çœ‹ `iptables -t nat -L -n -v` æ˜¯å¦åŒ…å« SNAT è§„åˆ™ï¼š

```sh
iptables -t nat -L POSTROUTING -n -v
```

å¦‚æœæ²¡æœ‰ï¼Œåˆ™éœ€è¦ï¼š

```sh
iptables -t nat -A POSTROUTING -s 10.0.0.0/24 -j MASQUERADE
```

> **æ³¨æ„**ï¼šå¦‚æœå®¿ä¸»æœºæœ‰å¤šä¸ªå‡ºå£ï¼ˆå¤šç½‘å¡ï¼‰ï¼Œå»ºè®®ä½¿ç”¨ `-o eth0` æŒ‡å®šå‡ºå£ç½‘å¡ï¼Œé¿å…é”™è¯¯è½¬æ¢ã€‚

------

#### **3. ç¡®ä¿ `conntrack` å·¥ä½œæ­£å¸¸**

å¦‚æœ `conntrack` è¡¨æ»¡ï¼Œå¯èƒ½å¯¼è‡´ NAT å¤±æ•ˆï¼Œæ£€æŸ¥ï¼š

```sh
sysctl net.netfilter.nf_conntrack_max
sysctl net.netfilter.nf_conntrack_count
```

è‹¥ `nf_conntrack_count` é€¼è¿‘ `nf_conntrack_max`ï¼Œéœ€è¦è°ƒæ•´ï¼š

```sh
sysctl -w net.netfilter.nf_conntrack_max=262144
```

------

#### **æ€»ç»“**

ç¡®ä¿å›åŒ…æ­£ç¡®è½¬æ¢å›å®¹å™¨ IPï¼Œéœ€è¦ï¼š

1. **iptables SNAT è§„åˆ™**ï¼ˆ`POSTROUTING MASQUERADE`ï¼‰ã€‚
2. **conntrack è®°å½• NAT æ˜ å°„**ï¼ˆ`conntrack -L`ï¼‰ã€‚
3. **è°ƒæ•´ conntrack æœ€å¤§è¡¨é¡¹**ï¼Œé¿å… NAT å¤±æ•ˆã€‚

è¿™æ ·ï¼ŒSNAT å¤„ç†çš„æµé‡å°±å¯ä»¥æ­£ç¡®å›åˆ°å®¹å™¨ï¼ ğŸš€

### 4.4 è‹¥æ˜¯å¤šä¸ªå®¹å™¨éƒ½å‘é€åˆ°åŒä¸€ä¸ªåœ°å€ï¼ŒSNAT æ˜¯å¦‚ä½•å°†å›åŒ…è¿˜åŸä¸ºå®¹å™¨ IPï¼Œæ ¹æ®ç«¯å£å—

æ˜¯çš„ï¼Œ**SNATï¼ˆSource NATï¼‰** ä¸»è¦ä¾èµ–äº **`conntrack` è¿æ¥è·Ÿè¸ªæœºåˆ¶**ï¼Œé€šè¿‡ **äº”å…ƒç»„ï¼ˆFive-Tupleï¼‰** æ¥åŒºåˆ†ä¸åŒå®¹å™¨çš„å›åŒ…ï¼Œå¹¶æ­£ç¡®è¿˜åŸæº IPã€‚

------

#### **ğŸ”¹ å¤šä¸ªå®¹å™¨è®¿é—®åŒä¸€ç›®æ ‡åœ°å€ï¼Œå¦‚ä½•æ­£ç¡®è¿˜åŸï¼Ÿ**

å‡è®¾å¤šä¸ªå®¹å™¨è®¿é—®åŒä¸€ä¸ªç›®æ ‡åœ°å€ï¼ˆå¦‚ `8.8.8.8`ï¼‰ï¼Œå®ƒä»¬çš„ IP å’Œç«¯å£å¦‚ä¸‹ï¼š

| **å®¹å™¨ IP** | **æºç«¯å£ (sport)** | **ç›®æ ‡ IP (dst)** | **ç›®æ ‡ç«¯å£ (dport)** |
| ----------- | ------------------ | ----------------- | -------------------- |
| `10.0.0.2`  | `50001`            | `8.8.8.8`         | `443` (HTTPS)        |
| `10.0.0.3`  | `50002`            | `8.8.8.8`         | `443` (HTTPS)        |

å½“æµé‡ç»è¿‡ SNATï¼Œæº IP è¢«ä¿®æ”¹ä¸ºå®¿ä¸»æœºå‡ºå£ IPï¼ˆå¦‚ `192.168.1.100`ï¼‰ï¼Œä½† **æºç«¯å£ï¼ˆsportï¼‰é€šå¸¸ä¿æŒä¸å˜æˆ–åŠ¨æ€åˆ†é…**ï¼š

| **NATåæº IP**  | **NATåæºç«¯å£ (sport)** | **ç›®æ ‡ IP (dst)** | **ç›®æ ‡ç«¯å£ (dport)** |
| --------------- | ----------------------- | ----------------- | -------------------- |
| `192.168.1.100` | `50001`                 | `8.8.8.8`         | `443` (HTTPS)        |
| `192.168.1.100` | `50002`                 | `8.8.8.8`         | `443` (HTTPS)        |

------

#### **ğŸ”¹ å›åŒ…æ—¶å¦‚ä½•æ˜ å°„å›æ­£ç¡®çš„å®¹å™¨ï¼Ÿ**

å½“ `8.8.8.8` å‘é€å›åŒ…æ—¶ï¼š

| **å›åŒ…æº IP** | **å›åŒ…æºç«¯å£ (sport)** | **å›åŒ…ç›®æ ‡ IP (dst)** | **å›åŒ…ç›®æ ‡ç«¯å£ (dport)** |
| ------------- | ---------------------- | --------------------- | ------------------------ |
| `8.8.8.8`     | `443`                  | `192.168.1.100`       | `50001`                  |
| `8.8.8.8`     | `443`                  | `192.168.1.100`       | `50002`                  |

**conntrack æœºåˆ¶** ç»´æŠ¤äº† SNAT è¿æ¥è·Ÿè¸ªè¡¨ï¼š

```sh
conntrack -L
```

è¾“å‡ºç±»ä¼¼ï¼š

```
tcp      6 431995 ESTABLISHED src=10.0.0.2 dst=8.8.8.8 sport=50001 dport=443 \
    src=8.8.8.8 dst=192.168.1.100 sport=443 dport=50001 [ASSURED]
tcp      6 431995 ESTABLISHED src=10.0.0.3 dst=8.8.8.8 sport=50002 dport=443 \
    src=8.8.8.8 dst=192.168.1.100 sport=443 dport=50002 [ASSURED]
```

è¿™æ ·ï¼š

1. **conntrack è¯†åˆ«å›åŒ…ç›®æ ‡ IP (`192.168.1.100`) å’Œç›®æ ‡ç«¯å£ (`50001`/`50002`)**
2. **æ ¹æ® NAT è®°å½•ï¼Œå›åŒ…æ­£ç¡®æ˜ å°„å› `10.0.0.2:50001` æˆ– `10.0.0.3:50002`**
3. **å®¹å™¨æ”¶åˆ°æ­£ç¡®çš„å“åº”**

------

#### **ğŸ”¹ ç»“è®º**

âœ” **SNAT ä¸»è¦ä¾é  `conntrack` è·Ÿè¸ªäº”å…ƒç»„**ï¼ˆæº IPã€æºç«¯å£ã€ç›®æ ‡ IPã€ç›®æ ‡ç«¯å£ã€åè®®ï¼‰ã€‚
 âœ” **ä¸åŒå®¹å™¨çš„å›åŒ…æ˜¯é€šè¿‡ç«¯å£æ˜ å°„å›å»çš„**ï¼Œå³ **ç›®çš„ IP+ç«¯å£ â†’ åŸå§‹å®¹å™¨ IP+ç«¯å£**ã€‚
 âœ” **`iptables` NAT è§„åˆ™é…åˆ `conntrack`ï¼Œç¡®ä¿å¤šä¸ªå®¹å™¨å¯ä»¥æ­£ç¡®æ¥æ”¶å›åŒ…**ã€‚ ğŸš€



