## 1. 容器 detach（-d 参数）

- [从零开始写 Docker(八)---实现 mydocker run -d 支持后台运行容器 -](https://www.lixueduan.com/posts/docker/mydocker/08-mydocker-run-d/)

1. 容器进程的启动逻辑是  mydocker run --> mydocker init（替换为容器实际的进程），简化为 mydocker 主程序进程 --> 容器进程
2. -d 指的是 detach，目前功能有限，-it 和 -d 参数不能同时使用（-it 指的是前台与容器进程交互，-d 指的是容器进程后台运行）
3. 此处容器后台运行，实际上就是将 mydocker 主程序进程杀死，让容器进程被宿主机 1 号进程纳管
   - 因此有个 bug：容器进程结束后，相应的 overlayfs 目录和 cgroup 等资源无法进行清理
   - 个人理解：此处与 docker 的 -d （容器进程后台运行）有差异，此处 -d 相当于模拟 docker 主进程被杀死后，容器进程被宿主机1号进程纳管

## 2. 容器信息记录（-name 参数，模拟 ps）

- [从零开始写 Docker(九)---实现 mydocker ps 查看运行中的容器 -](https://www.lixueduan.com/posts/docker/mydocker/09-mydocker-ps/)

### 2.1 持久化容器信息到宿主机 json 文件

1. 利用随机函数创建容器 ID（containerID）
2. run 命令增加参数 -name，可指定容器名称
3. 创建容器，记录容器信息（containerID 和 containerName 等，若未指定 -name， containerName=containerID）到宿主机上指定的 config.json 中

``` sh
$ go build .
$ ./my-docker run -it -name test sh
{"level":"debug","msg":"Current containerID is [4254293419]","time":"2025-02-28T15:09:22+08:00"}
{"level":"debug","msg":"ContainerInfo save path: /var/lib/mydocker/containers/4254293419/config.json","time":"2025-02-28T15:09:22+08:00"}

# 新开启个终端
# 上面容器终止退出后，该文件会被清理掉
$ cat /var/lib/mydocker/containers/4254293419/config.json
{"pid":"63051","id":"4254293419","name":"test","command":"sh","createdTime":"2025-02-28 15:09:22","status":"running"}
```

![持久化容器信息](imgs/3-容器操作进阶/持久化容器信息.png)

### 2.2 实现 ps 命令

- 上面容器启动把信息存储在`var/lib/mydocker/containers` 目录下

此处逻辑为

- 添加 ps 命令，并增加对应的处理函数，处理函数就是下面的几点运行逻辑

1. 读取 `var/lib/mydocker/containers` 目录下的所有文件夹就能拿到当前系统中的容器
2. 读取`/var/lib/mydocker/containers/{containerID}/config.json` 文件即可拿到对应容器的详细信息。
3. 将进行 json 解析，再打印出来，即可展示容器的运行信息

![ps展示容器信息](imgs/3-容器操作进阶/ps展示容器信息.png)


### 3.2 实现 rm 命令

- 备注：该命令执行前，要停止容器进程（stop），否则容器进程占用目录，无法完成目录的清理

1. 清理 cgroup 目录
2. 清理 volume 和 overlayfs 目录
3. 清理容器信息 json 文件

### 3.3 执行过程

``` sh
# 用 detach 方法运行容器，容器进程会被宿主机 1 号进程纳管
root@dfy-1:/go-code/my-docker# ./my-docker run -d top
{"level":"info","msg":"Run comand args[0]: [top]","time":"2025-03-03T10:41:19+08:00"}
{"level":"info","msg":"resConf:\u0026{ 0  }","time":"2025-03-03T10:41:19+08:00"}
{"level":"debug","msg":"Overlay mount Cmd: /usr/bin/mount [mount -t overlay overlay -o lowerdir=/go-code/my-docker/busybox,upperdir=/go-code/my-docker/upper,workdir=/go-code/my-docker/work /go-code/my-docker/merged] ","time":"2025-03-03T10:41:19+08:00"}
{"level":"debug","msg":"Current containerID is [4153757690]","time":"2025-03-03T10:41:19+08:00"}
{"level":"debug","msg":"ContainerInfo save path: /var/lib/mydocker/containers/4153757690/config.json","time":"2025-03-03T10:41:19+08:00"}
{"level":"info","msg":"command all is top","time":"2025-03-03T10:41:19+08:00"}

# 省略若干信息展示，可以看出 容器进程会被宿主机 1 号进程纳管
/go-code/my-docker# pstree -pl
systemd(1)─┬─accounts-daemon(714)─┬─{accounts-daemon}(721)
           │                      └─{accounts-daemon}(778)
           ├─top(67732)
           └─unattended-upgr(967)───{unattended-upgr}(1052)
           
# 查看容器 json 文件，验证 pid 是一致的
/var/lib/mydocker/containers# cat 4153757690/config.json
{"pid":"67732","id":"4153757690","name":"4153757690","command":"top","createdTime":"2025-03-03 10:41:19","status":"running","volume":""

# stop 命令停止容器
/go-code/my-docker# ./my-docker stop 4153757690
{"level":"debug","msg":"Container json file path: /var/lib/mydocker/containers/4153757690/config.json","time":"2025-03-03T10:54:30+08:00"}

# 容器 json 文件状态改为 stopped
/var/lib/mydocker/containers# cat 4153757690/config.json
{"pid":" ","id":"4153757690","name":"4153757690","command":"top","createdTime":"2025-03-03 10:41:19","status":"stopped","volume":""}

# 移除容器，清理目录
/go-code/my-docker# ./my-docker rm 4153757690
{"level":"debug","msg":"Container json file path: /var/lib/mydocker/containers/4153757690/config.json","time":"2025-03-03T10:55:12+08:00"}
{"level":"info","msg":"Staring Resource-Cleanning ...","time":"2025-03-03T10:55:12+08:00"}
{"level":"info","msg":"Cleaning mydocker-cgroup subsystem-cgroup-dirs","time":"2025-03-03T10:55:12+08:00"}
{"level":"info","msg":"Cleaning memory-cgroup-dir [/sys/fs/cgroup/memory/mydocker-cgroup]","time":"2025-03-03T10:55:12+08:00"}
{"level":"info","msg":"Finsh clean mydocker-cgroup subsystem-cgroup-dirs","time":"2025-03-03T10:55:12+08:00"}
{"level":"debug","msg":"Remove container overlayfs mountPoint and writeLayer.","time":"2025-03-03T10:55:12+08:00"}
{"level":"info","msg":"Finsh Container Resource Clean.","time":"2025-03-03T10:55:12+08:00"}

# 可以看到容器 json 文件也不存在了
/var/lib/mydocker/containers# ls
/var/lib/mydocker/containers#
```

